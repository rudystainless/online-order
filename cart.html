<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOPPING CART - RUDY</title>
    <style>
        /* ベーススタイル設定 */
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif; padding: 15px; background-color: #fff; color: #333; max-width: 800px; margin: 0 auto; line-height: 1.6; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; text-align: center; font-size: 1.2rem; }
        
        /* カートテーブルのレスポンシブ設定 */
        .cart-wrapper { overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background-color: #f9f9f9; text-align: left; padding: 12px; border-bottom: 2px solid #eee; font-size: 12px; color: #666; }
        td { padding: 15px 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        /* 商品表示レイアウト */
        .product-info { display: flex; align-items: center; }
        .product-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 2px; margin-right: 12px; background-color: #f5f5f5; border: 1px solid #eee; }
        .product-name-text { font-size: 13px; font-weight: 600; }

        .qty-controls { display: flex; align-items: center; gap: 8px; }
        .btn-qty { width: 26px; height: 26px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-delete { background: none; border: none; color: #bbb; cursor: pointer; font-size: 18px; padding: 0 5px; }

        .total-row { font-weight: bold; font-size: 16px; background-color: #fafafa; }
        .total-price { color: #d32f2f; text-align: right; }
        
        /* 顧客情報入力フォーム */
        .customer-form { border-top: 2px solid #1a1a1a; padding-top: 30px; }
        h3 { font-size: 15px; letter-spacing: 1px; margin-bottom: 20px; border-left: 4px solid #1a1a1a; padding-left: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; color: #666; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 0; box-sizing: border-box; font-size: 14px; outline: none; -webkit-appearance: none; }
        input:focus { border-color: #1a1a1a; }
        
        /* エラーメッセージ */
        .error-msg { color: #d32f2f; font-size: 11px; margin-top: 5px; display: none; }

        /* 送信ボタン */
        .btn-submit { background: #1a1a1a; color: white; width: 100%; padding: 18px; border: none; cursor: pointer; font-size: 15px; letter-spacing: 2px; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-submit:hover { background: #444; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

        .btn-clear { background: none; border: 1px solid #ccc; color: #999; padding: 5px 12px; font-size: 10px; cursor: pointer; float: right; margin-bottom: 10px; }
    </style>
</head>
<body>

    <button class="btn-clear" onclick="clearCart()">カートを空にする (CLEAR)</button>
    <h2>SHOPPING CART</h2>
    
    <div class="cart-wrapper">
        <table id="cartTable">
            <thead>
                <tr>
                    <th style="width: 45%;">商品名</th>
                    <th style="width: 15%;">単価</th>
                    <th style="width: 20%;">数量</th>
                    <th style="width: 15%;">小計</th>
                    <th style="width: 5%;"></th>
                </tr>
            </thead>
            <tbody id="cartItems"></tbody>
        </table>
    </div>

    <div class="customer-form">
        <h3>お客様情報入力 (CUSTOMER INFO)</h3>
        <div class="form-group">
            <label>会社名 / 団体名 (必須)</label>
            <input type="text" id="company" placeholder="例：株式会社RUDY" required>
        </div>
        <div class="form-group">
            <label>お名前・ご担当者名 (必須)</label>
            <input type="text" id="person" placeholder="例：田中 太郎" required>
        </div>
        <div class="form-group">
            <label>電話番号</label>
            <input type="tel" id="phone" placeholder="例：03-1234-5678">
        </div>
        <div class="form-group">
            <label>メールアドレス (必須・確認メール用)</label>
            <input type="email" id="email" placeholder="例：example@mail.com" required oninput="validateEmail()">
            <div id="emailError" class="error-msg">有効なメールアドレスを入力してください (@とドメインが必要です)</div>
        </div>
        <div class="form-group">
            <label>備考・お問い合わせ</label>
            <textarea id="note" placeholder="ご希望事項など" rows="4"></textarea>
        </div>
        <button class="btn-submit" id="submitBtn" onclick="processOrder()">注文を確定する (ORDER CONFIRM)</button>
    </div>

    <script>
        // 後端 GAS 部署網址
        const API_URL = "https://script.google.com/macros/s/AKfycbzxEYZ9QWeaFpIIjq8FbQIZu2qM_3DY5dxWxqxY5zq8ASxA4GuE19gro-dNGz9Pv7-X/exec";

        /**
         * カート内容の描画
         */
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            const tbody = document.getElementById('cartItems');
            let total = 0;
            
            if (cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 50px; color: #999;">カート内に商品はありません。</td></tr>';
                return;
            }

            tbody.innerHTML = cart.map((item, index) => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                return `
                <tr>
                    <td>
                        <div class="product-info">
                            <img src="${item.img || ''}" class="product-thumb">
                            <span class="product-name-text">${item.name}</span>
                        </div>
                    </td>
                    <td>¥${item.price.toLocaleString()}</td>
                    <td>
                        <div class="qty-controls">
                            <button class="btn-qty" onclick="updateQty(${index}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="btn-qty" onclick="updateQty(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>¥${subtotal.toLocaleString()}</td>
                    <td><button class="btn-delete" onclick="removeItem(${index})">✕</button></td>
                </tr>`;
            }).join('');

            tbody.innerHTML += `
                <tr class="total-row">
                    <td colspan="3" style="text-align:right">合計 (TOTAL):</td>
                    <td colspan="2" class="total-price">¥${total.toLocaleString()}</td>
                </tr>`;
        }

        window.updateQty = (index, change) => {
            let cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            cart[index].qty += change;
            if (cart[index].qty < 1) cart.splice(index, 1);
            localStorage.setItem('rudy_cart', JSON.stringify(cart));
            renderCart();
        };

        window.removeItem = (index) => {
            let cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            cart.splice(index, 1);
            localStorage.setItem('rudy_cart', JSON.stringify(cart));
            renderCart();
        };

        window.clearCart = () => {
            if(confirm("カートを空にしますか？")) {
                localStorage.removeItem('rudy_cart');
                renderCart();
            }
        };

        /**
         * Email形式のバリデーション (推論F)
         */
        function validateEmail() {
            const email = document.getElementById('email').value;
            const error = document.getElementById('emailError');
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isValid = re.test(email);
            error.style.display = isValid || email === "" ? "none" : "block";
            return isValid;
        }

        /**
         * 注文処理の実行
         */
        async function processOrder() {
            const cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            if (cart.length === 0) return alert("カートが空です。");

            const company = document.getElementById('company').value.trim();
            const person = document.getElementById('person').value.trim();
            const email = document.getElementById('email').value.trim();

            // 基本バリデーション
            if (!company || !person || !email) {
                return alert("会社名、お名前、メールアドレスは必須項目です。");
            }

            // Email形式チェック
            if (!validateEmail()) {
                return alert("メールアドレスの形式が正しくありません。");
            }

            const payload = {
                company: company,
                person: person,
                phone: document.getElementById('phone').value.trim(),
                email: email,
                note: document.getElementById('note').value.trim(),
                items: cart
            };

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "送信中 (SENDING...)";

            try {
                // GASのdoPostへ送信
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // GAS互換用
                    body: JSON.stringify(payload)
                });
                
                // 成功時は localStorage をクリアして完了画面へ
                alert("ご注文ありがとうございます！\n注文完了メールとPDF明細を送付しました。");
                localStorage.removeItem('rudy_cart');
                window.location.reload();

            } catch (e) {
                console.error(e);
                alert("送信エラーが発生しました。");
            } finally {
                btn.disabled = false;
                btn.innerText = "注文を確定する (ORDER CONFIRM)";
            }
        }

        window.onload = renderCart;
    </script>
</body>
</html>
