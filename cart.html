<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カート</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
        .total-row { font-weight: bold; background: #f9f9f9; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        .btn-submit { background: #28a745; color: white; width: 100%; padding: 15px; border: none; cursor: pointer; font-size: 16px; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ショッピングカート</h2>
    <table id="cartTable">
        <thead>
            <tr><th>商品名</th><th>単価</th><th>数量</th><th>小計</th><th>削除</th></tr>
        </thead>
        <tbody id="cartItems"></tbody>
    </table>

    <h3>お客様情報</h3>
    <input type="text" id="company" placeholder="会社名" required>
    <input type="text" id="person" placeholder="担当者名" required>
    <input type="text" id="phone" placeholder="電話番号">
    <input type="email" id="email" placeholder="メールアドレス">
    <textarea id="note" placeholder="備考" rows="3"></textarea>

    <button class="btn-submit" id="submitBtn" onclick="sendToGAS()">注文を確定する</button>

    <script>
        // 你的 GAS 網址
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyRVqaR6BD8IvICebGuKfR8mSX5Ewr6YDhYhB5pUPlWP7P_GhiYmerux0AtoDBWs4_CNg/exec";

        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            const tbody = document.getElementById('cartItems');
            let total = 0;
            
            if(cart.length === 0){
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">カートは空です</td></tr>';
                return;
            }

            tbody.innerHTML = cart.map((item, index) => {
                total += item.price * item.qty;
                return `
                <tr>
                    <td>${item.name}</td>
                    <td>¥${item.price}</td>
                    <td>${item.qty}</td>
                    <td>¥${item.price * item.qty}</td>
                    <td><button class="btn-delete" onclick="removeItem(${index})">削除</button></td>
                </tr>`;
            }).join('');

            // 追加總計行
            tbody.innerHTML += `<tr class="total-row"><td colspan="3" style="text-align:right">合計:</td><td colspan="2">¥${total}</td></tr>`;
        }

        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            cart.splice(index, 1);
            localStorage.setItem('rudy_cart', JSON.stringify(cart));
            renderCart();
        }

        async function sendToGAS() {
            const cart = JSON.parse(localStorage.getItem('rudy_cart') || '[]');
            if (cart.length === 0) return alert("カートが空です");

            const payload = {
                company: document.getElementById('company').value,
                person: document.getElementById('person').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                note: document.getElementById('note').value,
                items: cart
            };

            if (!payload.company || !payload.person) {
                return alert("会社名と担当者名は必須です");
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "送信中...";

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert("注文が送信されました！");
                localStorage.removeItem('rudy_cart');
                renderCart();
                // 這裡可以選擇清空表單
                document.getElementById('company').value = '';
                document.getElementById('person').value = '';
            } catch (e) {
                alert("エラーが発生しました");
            } finally {
                btn.disabled = false;
                btn.innerText = "注文を確定する";
            }
        }

        window.onload = renderCart;
    </script>
</body>
</html>
